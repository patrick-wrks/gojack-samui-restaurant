# Supabase Database Schema Documentation

Last updated: 2025-02-28

## Overview

This document tracks all database tables, their structure, and RLS policies for the POS system.

---

## Table of Contents

1. [Categories](#categories)
2. [Products](#products)
3. [Orders](#orders)
4. [Order Items](#order_items)
5. [Store Settings](#store_settings)
6. [Realtime Configuration](#realtime-configuration)
7. [Common Queries](#common-queries)
8. [Frontend Functions](#frontend-functions)

---

## Features

- ‚úÖ Categories & Products - Menu management
- ‚úÖ Orders & Order Items - Order tracking with CASCADE delete
- ‚úÖ RLS Policies - Row Level Security for authenticated users
- ‚úÖ Realtime - Live updates for menu and orders
- ‚úÖ **Delete Orders** - Remove orders from Reports page (with confirmation dialog)

---

## Categories

Stores menu categories.

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| id | TEXT | PRIMARY KEY | String ID like 'krapow', 'curry' |
| name | TEXT | NOT NULL | Display name in Thai |
| color | TEXT | NOT NULL, DEFAULT '#6b7280' | Hex color for UI |
| sort_order | INT | NOT NULL, DEFAULT 0 | Display order |

**RLS Policy:** `categories_authenticated_all` - All authenticated users can read/write

**Current Data (9 categories):**
- krapow (‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤), curry (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏Å‡∏á), stir (‡∏ú‡∏±‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ), rice (‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î/‡∏£‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤)
- somtam (‡∏™‡πâ‡∏°‡∏ï‡∏≥/‡∏¢‡∏≥), soup (‡πÅ‡∏Å‡∏á‡∏™‡πâ‡∏°/‡∏ï‡πâ‡∏°), seafood (‡∏ó‡∏∞‡πÄ‡∏•/‡∏õ‡∏•‡∏≤)
- special (‡∏û‡∏¥‡πÄ‡∏®‡∏©), side (‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°)

---

## Products

Menu items/products.

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| id | BIGINT | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY | Auto-incrementing |
| category_id | TEXT | NOT NULL, FK ‚Üí categories(id) | Category reference |
| name | TEXT | NOT NULL | Product name in Thai |
| price | NUMERIC(10,2) | NOT NULL, CHECK (price >= 0) | Price in THB |
| is_active | BOOLEAN | NOT NULL, DEFAULT true | Show/hide in menu |
| sort_order | INT | NOT NULL, DEFAULT 0 | Display order |

**RLS Policy:** `products_authenticated_all` - All authenticated users can read/write

**Current Data:** 51 products (see migration file for full list)

**Fix Sequence:**
```sql
SELECT setval(pg_get_serial_sequence('products', 'id'), COALESCE((SELECT MAX(id) FROM products), 1));
```

---

## Orders ‚≠ê NEEDS TO BE CREATED

Stores completed orders. **This table does not exist yet** - run the SQL below in Supabase SQL Editor.

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| id | UUID | PRIMARY KEY, DEFAULT gen_random_uuid() | Auto-generated |
| order_number | INT | NOT NULL | Sequential order number (1, 2, 3...) |
| total | NUMERIC(10,2) | NOT NULL | Total order amount |
| payment_method | TEXT | NOT NULL, CHECK (payment_method IN ('cash', 'bank')) | 'cash' or 'bank' |
| status | TEXT | NOT NULL, DEFAULT 'completed', CHECK (status IN ('completed', 'cancelled')) | Order status |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | Auto timestamp |

**RLS Policy:** `orders_authenticated_all` - All authenticated users can read/write

**Indexes:**
- `idx_orders_created_at` on created_at DESC
- `idx_orders_created_at_status` on (created_at, status)

**SQL to create:**
```sql
CREATE TABLE IF NOT EXISTS orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_number INT NOT NULL,
  total NUMERIC(10, 2) NOT NULL,
  payment_method TEXT NOT NULL CHECK (payment_method IN ('cash', 'bank')),
  status TEXT NOT NULL DEFAULT 'completed' CHECK (status IN ('completed', 'cancelled')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "orders_authenticated_all" ON orders;
CREATE POLICY "orders_authenticated_all" ON orders
  FOR ALL TO authenticated USING (true) WITH CHECK (true);

CREATE INDEX IF NOT EXISTS idx_orders_created_at ON orders(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_orders_created_at_status ON orders(created_at, status);
```

---

## Order Items ‚≠ê NEEDS TO BE CREATED

Line items for each order. **This table does not exist yet** - run with orders SQL.

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| id | UUID | PRIMARY KEY, DEFAULT gen_random_uuid() | Auto-generated |
| order_id | UUID | NOT NULL, FK ‚Üí orders(id) ON DELETE CASCADE | Parent order |
| product_id | BIGINT | FK ‚Üí products(id) | Optional link to product |
| product_name | TEXT | NOT NULL | Product name at time of sale |
| qty | INT | NOT NULL, CHECK (qty > 0) | Quantity ordered |
| price_at_sale | NUMERIC(10,2) | NOT NULL | Price at time of sale |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | Auto timestamp |

**RLS Policy:** `order_items_authenticated_all` - All authenticated users can read/write

**Indexes:**
- `idx_order_items_order_id` on order_id
- `idx_order_items_product_id` on product_id

**SQL to create:**
```sql
CREATE TABLE IF NOT EXISTS order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
  product_id BIGINT REFERENCES products(id),
  product_name TEXT NOT NULL,
  qty INT NOT NULL CHECK (qty > 0),
  price_at_sale NUMERIC(10, 2) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "order_items_authenticated_all" ON order_items;
CREATE POLICY "order_items_authenticated_all" ON order_items
  FOR ALL TO authenticated USING (true) WITH CHECK (true);

CREATE INDEX IF NOT EXISTS idx_order_items_order_id ON order_items(order_id);
CREATE INDEX IF NOT EXISTS idx_order_items_product_id ON order_items(product_id);
```

---

## Store Settings (Optional)

Bank account and store info for receipts. Check if this exists.

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| id | BIGINT | PRIMARY KEY, DEFAULT 1 | Single row |
| store_name | TEXT | | Restaurant name |
| bank_name | TEXT | | Bank name |
| bank_account_number | TEXT | | Account number |
| bank_account_name | TEXT | | Account holder name |
| receipt_footer | TEXT | | Custom footer text |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | Last update |

**SQL to check if exists:**
```sql
SELECT * FROM information_schema.tables WHERE table_name = 'store_settings';
```

---

## Realtime Configuration

Tables enabled for realtime subscriptions:

| Table | Status | Notes |
|-------|--------|-------|
| categories | ‚úÖ Enabled | Menu changes propagate |
| products | ‚úÖ Enabled | Menu changes propagate |
| orders | ‚ö†Ô∏è Needs enabling | For live order updates |

**SQL to enable realtime:**
```sql
-- For categories and products (should already be enabled)
ALTER PUBLICATION supabase_realtime ADD TABLE categories;
ALTER PUBLICATION supabase_realtime ADD TABLE products;

-- For orders (needs to be run after creating orders table)
ALTER PUBLICATION supabase_realtime ADD TABLE orders;
```

---

## Quick Reference: Current Status

### ‚úÖ Tables That Exist (Verify in Supabase)
1. categories - Menu categories
2. products - Menu items

### ‚≠ê Tables That Need to be Created
1. **orders** - Order headers (critical for analytics)
2. **order_items** - Order line items (critical for analytics)

### üìù Optional Tables
1. store_settings - Bank info for receipts

---

## Setup Checklist for New Environment

1. ‚úÖ Create categories table
2. ‚úÖ Create products table
3. ‚≠ê **Create orders table** (run SQL above)
4. ‚≠ê **Create order_items table** (run SQL above)
5. ‚úÖ Enable RLS policies
6. ‚úÖ Enable realtime
7. ‚úÖ Seed categories data
8. ‚úÖ Seed products data

---

## Common Queries

### Get today's orders
```sql
SELECT * FROM orders 
WHERE created_at >= CURRENT_DATE 
  AND status = 'completed'
ORDER BY created_at DESC;
```

### Get order with items
```sql
SELECT o.*, oi.product_name, oi.qty, oi.price_at_sale
FROM orders o
JOIN order_items oi ON o.id = oi.order_id
WHERE o.id = 'uuid-here';
```

### Get revenue by day
```sql
SELECT 
  DATE(created_at) as date,
  COUNT(*) as order_count,
  SUM(total) as revenue
FROM orders
WHERE status = 'completed'
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

### Delete an order (cascade deletes items)
```sql
-- Delete order (order_items will be automatically deleted due to ON DELETE CASCADE)
DELETE FROM orders WHERE id = 'uuid-here';
```

## Frontend Functions

### Insert Order
```typescript
import { insertOrder } from '@/lib/orders';

await insertOrder({
  orderNumber: 42,
  total: 350.00,
  paymentMethod: 'cash', // or 'bank'
  items: [
    { id: 1, name: '‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π', price: 70, qty: 1 },
    // ...
  ],
});
```

### Fetch Orders for Reports
```typescript
import { fetchOrdersWithItems } from '@/lib/orders';

const orders = await fetchOrdersWithItems('2025-02-28 00:00:00', '2025-02-28 23:59:59');
```

### Delete Order
```typescript
import { deleteOrder } from '@/lib/orders';

await deleteOrder('order-uuid-here');
// Automatically deletes associated order_items due to CASCADE
```

---

## Migration Files

Local migration files in `/supabase/migrations/`:
- `001_menu.sql` - Categories and products
- `005_orders.sql` - Orders and order_items
- `006_store_bank_info.sql` - Store settings

**Note:** These files are for reference. SQL must be run manually in Supabase Dashboard.
